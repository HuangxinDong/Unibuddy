#pragma once
#include <Arduino.h>

// ── Pet mood ─────────────────────────────────────────────────
enum PetMood {
  MOOD_HAPPY,
  MOOD_FOCUSED,
  MOOD_TIRED,
  MOOD_EXCITED,
  MOOD_ASLEEP
};

static PetMood  _mood          = MOOD_HAPPY;
static uint8_t  _animFrame     = 0;
static uint32_t _lastAnimTick  = 0;
static uint32_t _animInterval  = 400;  // ms per frame

// ── Pixel art frames (16x16, 1bpp, stored as 2 rows of bytes)
// Each frame = 32 bytes. Drawn via Adafruit GFX drawBitmap.
// 
// HAPPY face — 2 frames (blinking)
const uint8_t PET_HAPPY_0[] PROGMEM = {
  0x00,0x00, 0x07,0xE0, 0x18,0x18, 0x20,0x04,
  0x44,0x22, 0x44,0x22, 0x80,0x01, 0x80,0x01,
  0x80,0x01, 0x99,0x99, 0xA0,0x05, 0x40,0x02,
  0x20,0x04, 0x18,0x18, 0x07,0xE0, 0x00,0x00
};
const uint8_t PET_HAPPY_1[] PROGMEM = {  // blink
  0x00,0x00, 0x07,0xE0, 0x18,0x18, 0x20,0x04,
  0x4C,0x32, 0x40,0x02, 0x80,0x01, 0x80,0x01,
  0x80,0x01, 0x99,0x99, 0xA0,0x05, 0x40,0x02,
  0x20,0x04, 0x18,0x18, 0x07,0xE0, 0x00,0x00
};

// FOCUSED face — squinting eyes
const uint8_t PET_FOCUSED[] PROGMEM = {
  0x00,0x00, 0x07,0xE0, 0x18,0x18, 0x20,0x04,
  0x7C,0x3E, 0x00,0x00, 0x80,0x01, 0x80,0x01,
  0x80,0x01, 0x9F,0xF9, 0xA0,0x05, 0x40,0x02,
  0x20,0x04, 0x18,0x18, 0x07,0xE0, 0x00,0x00
};

// TIRED face — half-closed eyes, small mouth
const uint8_t PET_TIRED[] PROGMEM = {
  0x00,0x00, 0x07,0xE0, 0x18,0x18, 0x20,0x04,
  0x7C,0x3E, 0x00,0x00, 0x80,0x01, 0x80,0x01,
  0x80,0x01, 0x80,0x01, 0x87,0xE1, 0x40,0x02,
  0x20,0x04, 0x18,0x18, 0x07,0xE0, 0x00,0x00
};

// EXCITED — big eyes, open mouth
const uint8_t PET_EXCITED[] PROGMEM = {
  0x00,0x00, 0x07,0xE0, 0x18,0x18, 0x24,0x24,
  0x66,0x66, 0x66,0x66, 0x80,0x01, 0x80,0x01,
  0x81,0x81, 0xFF,0xFF, 0xBF,0xFD, 0x40,0x02,
  0x20,0x04, 0x18,0x18, 0x07,0xE0, 0x00,0x00
};

void tickPetAnimation() {
  if (millis() - _lastAnimTick < _animInterval) return;
  _lastAnimTick = millis();
  _animFrame = (_animFrame + 1) % 2;
}

void setPetMood(PetMood mood) {
  _mood = mood;
  _animFrame = 0;
}

PetMood getPetMood() { return _mood; }

// Returns the correct bitmap pointer for current state
const uint8_t* getPetBitmap() {
  switch (_mood) {
    case MOOD_FOCUSED:  return PET_FOCUSED;
    case MOOD_TIRED:    return PET_TIRED;
    case MOOD_EXCITED:  return PET_EXCITED;
    case MOOD_HAPPY:
    default:
      return (_animFrame == 0) ? PET_HAPPY_0 : PET_HAPPY_1;
  }
}

// Call after N sessions to update mood
void updatePetMoodFromSessions(uint8_t sessions) {
  if      (sessions == 0) setPetMood(MOOD_HAPPY);
  else if (sessions <= 2) setPetMood(MOOD_FOCUSED);
  else if (sessions <= 4) setPetMood(MOOD_EXCITED);
  else                    setPetMood(MOOD_TIRED);
}
